<!DOCTYPE html>

<html>
<head>
<style>

.slidecontainer {
  width: 100%; /* Width of the outside container */
}

.slider {
  -webkit-appearance: none;
  width: 10%;
  height: 10px;
  border-radius: 1px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

/* Mouse-over effects */
.slider:hover {
  opacity: 1; /* Fully shown on mouse-over */
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 15px;
  height: 15px;
  border-radius: 50%;
  background: #04AA6D;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background: #04AA6D;
  cursor: pointer;
}

</style>

</head>

<title>Silver Behenate Diffraction Simulator</title>

<body>

<script type="text/javascript">

function sliderChange(val, output_id) {
    document.getElementById(output_id).innerHTML = val;
}

function draw() {
   var detdist = parseFloat(document.getElementById("detdist").value);
   var apix = parseFloat(document.getElementById("pixsize").value);
   var detsize = parseFloat(document.getElementById("detsize").value);
   var energy = parseFloat(document.getElementById("energy").value);
   var wavelength = 1.2398 / energy; // in nm

   var nx = detsize, ny = detsize;

   var canvas = document.getElementById("rings");
   canvas.width = canvas.height = detsize;

   var ctx = canvas.getContext("2d");
   ctx.font = "30px Arial";
   ctx.textAlign = "right";
   ctx.fillStyle = "white";


   var img_data = ctx.createImageData(ny, nx);

   var idx = 0;
   for (var i = 0; i < ny; i++) {
      var iy = (i - ny / 2.0)
      var sy = iy / ny / apix;
      var ry = iy * apix;
      var iy2 = iy * iy;
      var sy2 = sy * sy;
      var ry2 = ry * ry;
      for (var j = 0; j < nx; j++) {
         var ix = (j - nx / 2)
         var sx = ix / nx / apix;
         var rx = ix * apix;
         var i2 = iy2 + ix * ix;
         var s2 = sy2 + sx * sx;
         var r2 = ry2 + rx * rx;

         var d = Math.sqrt(r2);

         var color = 0;
         if (d < 5 ) {
            color = 180;
         }
         if (color < 0) color = 0;
         if (color > 255) color = 255;

         img_data.data[idx    ] = color; // R
         img_data.data[idx + 1] = color; // G
         img_data.data[idx + 2] = color; // B
         img_data.data[idx + 3] = 255;   // A

         if (i2 > 0) {
            var resol = Math.sqrt(i2);
            for (var k = 1; k < 14; k++) {
                ds = k * 0.0171;
                iring = detdist * Math.tan(2.0 * Math.asin(ds * wavelength * 10. / 2.0)) / apix;

                if (Math.abs(resol - iring) < 1) {
                    img_data.data[idx] = 255;
                    img_data.data[idx + 1] = 255;
                    img_data.data[idx + 2] = 0;
                }
            }
            ilowres = 5.0 / apix;
            if (Math.abs(resol - ilowres) < 2) {
                img_data.data[idx] = 255;
                img_data.data[idx + 1] = 255;
                img_data.data[idx + 2] = 255;
            }

            ihires = nx/2;
            if (Math.abs(resol - ihires) < 2) {
                img_data.data[idx] = 255;
                img_data.data[idx + 1] = 255;
                img_data.data[idx + 2] = 255;
            }

            lowres = 2.0 * Math.PI * 2.0 * Math.sin(Math.atan(5.0 / detdist) / 2.0) / wavelength / 10.
            hires = 2.0 * Math.PI * 2.0 * Math.sin(Math.atan(ihires * apix / detdist) / 2.0) / wavelength / 10.
         }

         idx += 4;
      }
   }

   ctx.putImageData(img_data, 0, 0);
   ctx.fillText(Number(lowres.toFixed(2))+' A-1 ', canvas.width/2 - ilowres, canvas.height/2);
   ctx.fillText(Number(hires.toFixed(2))+' A-1 ', canvas.width/2 + ihires, canvas.height/2);
}
</script>


<body>

<h1>Silver Behenate Rings Simulator</h1>
<p>This interactive page allows you to simulate Silver Behenate rings as they would appear on an LCLS detector.</p>
<p> (move the cursors to update the image).</p>

<form>
    <div class="slidecontainer">
        Detector distance:
        <input type="range" id="detdist" min="1" max="300" value="60" class="slider" oninput="sliderChange(this.value, 'detdistvalue')" onchange="draw()">
        <output id="detdistvalue"></output> (mm)
    </div><br>
    <div class="slidecontainer">
        Pixel size:
        <input type="range" id="pixsize" min="0.05" max="0.5" value="0.075" step="0.005"class="slider" oninput="sliderChange(this.value, 'pixsizevalue')" onchange="draw()">
        <output id="pixsizevalue"></output> (mm)
    </div><br>
    <div class="slidecontainer">
        Detector size:
        <input type="range" id="detsize" min="100" max="2500" value="2100" step="1"class="slider" oninput="sliderChange(this.value, 'detsizevalue')" onchange="draw()">
        <output id="detsizevalue"></output> (pixels)
     </div><br>
    <div class="slidecontainer">
        Wavelength:
        <input type="range" id="energy" min="3" max="20" value="7" step="0.5"class="slider" oninput="sliderChange(this.value, 'energyvalue')" onchange="draw()">
        <output id="energyvalue"></output> (keV)
     </div><br>
</form>
<canvas id="rings" width=512 height=512 style="border:1px solid black">
</canvas>

<footer>
<p>This page was inspired by CTF calculator written by Takanori Nakane at MRC-LMB: https://3dem.github.io/relion/ctf.html. This page uses Javascript for calculation.</p>
</footer>
</body>
</html>
